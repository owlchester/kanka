import{j as U,c as r,a as i,f as h,b as l,t as c,w as x,h as V,e as k,u as I,F as w,g as C,v as z,d as K,r as m,o as L,l as P,i as q,q as A}from"./vue.esm-bundler-CSDHRrjm.js";import{v as J}from"./v-click-outside.umd-BCtVgRUL.js";import{_ as M}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./_commonjsHelpers-CqkleIqs.js";const G={directives:{clickOutside:J.directive},props:["message","trans"],data(){return{openedDropdown:!1}},computed:{isUser:function(){return this.message.user!==null},isCharacter:function(){return this.message.character!==null}},emits:["delete_message","edit_message"],methods:{deleteMessage:function(e){this.$emit("delete_message",e),this.onClickOutside()},editMessage:function(e){this.$emit("edit_message",e),this.onClickOutside()},translate(e){return this.trans[e]??"unknown"},dropdownClass(){return this.openedDropdown?"open dropdown relative":"dropdown relative"},openDropdown(){return this.openedDropdown=!0},boxClasses:function(e){let s="box-comment bg-base-100 p-2 flex flex-col gap-1";return s+=" message-author-"+e.from_id,s+=" message-real-author-"+e.created_by,e.group?s+=" message-followup":s+=" message-first",s},onClickOutside(e){this.openedDropdown=!1}}},Q={key:0,class:"flex items-center gap-1"},R={class:"message-author"},W={key:0,class:"user"},X={key:1,class:"character"},Y={key:2,class:"unknown"},Z={class:"grow"},$={key:0,class:"text-xs text-neutral-content"},ee={key:0,class:"message-options"},se={class:""},te={key:1,class:"flex gap-1"},ae={class:"comment-text"},ne=["title"];function ie(e,s,a,d,g,n){const o=U("click-outside");return i(),r("div",{class:k(n.boxClasses(a.message))},[a.message.group?h("",!0):(i(),r("div",Q,[l("div",R,[n.isUser?(i(),r("strong",W,c(a.message.user),1)):n.isCharacter?(i(),r("strong",X,[l("span",null,c(a.message.character),1)])):(i(),r("strong",Y,c(n.translate("user_unknown")),1))]),l("div",Z,[a.message.group?h("",!0):(i(),r("span",$,c(a.message.created_at),1))]),a.message.can_delete?(i(),r("div",ee,[x((i(),r("div",se,[this.openedDropdown?(i(),r("div",te,[l("a",{class:"btn2 btn-xs btn-default",onClick:s[1]||(s[1]=u=>n.editMessage(a.message))},c(n.translate("edit")),1),l("a",{class:"btn2 btn-xs btn-error",onClick:s[2]||(s[2]=u=>n.deleteMessage(a.message))},c(n.translate("remove")),1)])):(i(),r("a",{key:0,onClick:s[0]||(s[0]=u=>n.openDropdown()),role:"button"},s[3]||(s[3]=[l("i",{class:"fa-solid fa-caret-down","aria-hidden":"true"},null,-1)])))])),[[o,n.onClickOutside]])])):h("",!0)])),l("div",ae,[V(c(a.message.message)+" ",1),a.message.is_updated?(i(),r("span",{key:0,class:"text-xs text-neutral-content italic float-right",title:a.message.updated_at},c(n.translate("is_updated")),9,ne)):h("",!0)])],2)}const re=M(G,[["render",ie]]),le={props:{target:void 0,api:void 0,targets:void 0,disabled:{type:Boolean},current_message:{type:Object,default:null},trans:void 0},emits:["sending_message","edited_message","sent_message"],data(){return{body:null,sending:!1,character_id:null,message_id:null,edit_message:null}},methods:{typing(e){e.keyCode===13&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())},editMessage(e){this.message_id=e.id,this.edit_message=e,this.body=e.message,this.character_id=e.from_id,document.getElementById("message").focus()},sendMessage(){if(!this.body||this.body.trim()===""||this.targetCharacter&&this.character_id===null)return;this.sending=!0,this.$emit("sending_message");let e=this.api,s={message:this.body.trim()};this.targetCharacter&&(s.character_id=this.character_id),this.message_id?(e+="/"+this.message_id,axios.put(e,s).then(a=>{this.$emit("edited_message",a.data.data),this.messageHandler()}).catch(()=>{this.sending=!1})):axios.post(e,s).then(()=>{this.messageHandler()}).catch(()=>{this.sending=!1})},messageHandler(){this.sending=!1,this.body=null,this.message_id=null,this.$emit("sent_message")},translate(e){return this.json_trans[e]??"unknown"},boxClass(){let e="bg-base-100";return this.current_message&&(e="bg-accent"),"box-footer rounded p-2 "+e}},computed:{targetCharacter:function(){return this.target==="character"},inputFormDisabled:function(){return this.sending},commentable:function(){return this.targetCharacter?this.targets!==null:!0}},watch:{current_message:{handler(e,s){e!==s&&e&&this.editMessage(e)}}}},de={class:"flex items-center gap-2"},oe={key:0,class:"max-w-xs"},ue=["value"],ce={class:"field grow"},ge=["placeholder","disabled"];function me(e,s,a,d,g,n){return n.commentable?(i(),r("div",{key:0,class:k(n.boxClass())},[l("div",de,[n.targetCharacter?(i(),r("div",oe,[x(l("select",{class:"w-full","onUpdate:modelValue":s[0]||(s[0]=o=>g.character_id=o)},[(i(!0),r(w,null,C(a.targets,(o,u)=>(i(),r("option",{value:u,key:u},c(o),9,ue))),128))],512),[[I,g.character_id]])])):h("",!0),l("div",ce,[x(l("input",{type:"text",id:"message",maxlength:"1000",autocomplete:"off",class:"w-full",onKeydown:s[1]||(s[1]=(...o)=>n.typing&&n.typing(...o)),"onUpdate:modelValue":s[2]||(s[2]=o=>g.body=o),placeholder:a.disabled?n.translate("is_closed"):"",disabled:n.inputFormDisabled||a.disabled},null,40,ge),[[z,g.body]])])])],2)):h("",!0)}const he=M(le,[["render",me]]),_e={class:"viewport box-conversation p-2 flex flex-col gap-2"},fe={key:1,class:"load-more text-center text-2xl"},ve={key:2,class:"text-center"},pe=K({__name:"Conversation",props:{id:{},send:{},target:{},api:{},targets:{},trans:{},disabled:{type:Boolean}},setup(e){const s=e,a=m(),d=m([]),g=m(!1),n=m(null),o=m(!1),u=m(!1),b=m(!0),v=m(null),p=m(null),y=()=>{axios.get(s.api,{params:{newest:n.value}}).then(t=>{g.value=!1,d.value.push(...t.data.data.messages),o.value=t.data.data.previous,b.value=!1,B()})},B=()=>{setTimeout(()=>{v.value.scrollTop=v.value.scrollHeight},50),d.value.length>0?n.value=d.value[d.value.length-1].id:n.value=void 0},O=()=>{u.value=!0,axios.get(s.api,{params:{oldest:d.value[0].id}}).then(t=>{d.value.unshift(...t.data.data.messages),o.value=t.data.data.previous,u.value=!1})},F=t=>{axios.delete(t.delete_url).then(()=>{const _=d.value.findIndex(f=>f.id===t.id);d.value.splice(_,1)})},N=t=>a.value[t]??"unknown",S=t=>{g.value=!0},T=t=>{p.value=t},j=t=>{const _=d.value.findIndex(f=>f.id===t.id);d.value[_]=t},E=t=>{p.value=null,y()},H=t=>{F(t)};return L(()=>{a.value=JSON.parse(s.trans),y()}),(t,_)=>(i(),r("div",_e,[l("div",{class:"flex flex-col gap-2 box-comments overflow-auto",ref_key:"messageBox",ref:v},[o.value&&!u.value?(i(),r("div",{key:0,class:"load-more cursor-pointer text-center hover:text-primary",onClick:O},c(N("load_previous")),1)):h("",!0),u.value||b.value?(i(),r("div",fe,_[0]||(_[0]=[l("i",{class:"fa-solid fa-spin fa-spinner","aria-label":"Loading"},null,-1)]))):h("",!0),(i(!0),r(w,null,C(d.value,f=>(i(),q(re,{key:f.id,message:f,trans:a.value,onDelete_message:H,onEdit_message:T},null,8,["message","trans"]))),128)),g.value?(i(),r("div",ve,_[1]||(_[1]=[l("i",{class:"fa-solid fa-spin fa-spinner"},null,-1)]))):h("",!0)],512),P(he,{api:t.send,target:t.target,targets:t.targets,disabled:t.disabled,trans:a.value,current_message:p.value,onSending_message:S,onEdited_message:j,onSent_message:E},null,8,["api","target","targets","disabled","trans","current_message"])]))}}),D=A({});D.component("conversation",pe);D.mount("#conversation");
