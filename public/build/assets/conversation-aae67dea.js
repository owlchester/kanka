import{m as U,b as n,c as l,a as r,t as u,e as h,j as x,f as V,g as k,z,F as w,r as C,v as I,d as K,p as m,o as L,l as P,h as q,q as A}from"./vue.esm-bundler-e40214d7.js";import{v as J}from"./v-click-outside.umd-1708c20a.js";import{_ as M}from"./_plugin-vue_export-helper-c27b6911.js";import"./_commonjsHelpers-725317a4.js";const G={directives:{clickOutside:J.directive},props:["message","trans"],data(){return{openedDropdown:!1}},computed:{isUser:function(){return this.message.user!==null},isCharacter:function(){return this.message.character!==null}},emits:["delete_message","edit_message"],methods:{deleteMessage:function(e){this.$emit("delete_message",e),this.onClickOutside()},editMessage:function(e){this.$emit("edit_message",e),this.onClickOutside()},translate(e){return this.trans[e]??"unknown"},dropdownClass(){return this.openedDropdown?"open dropdown relative":"dropdown relative"},openDropdown(){return this.openedDropdown=!0},boxClasses:function(e){let s="box-comment bg-base-100 p-2 flex flex-col gap-1";return s+=" message-author-"+e.from_id,s+=" message-real-author-"+e.created_by,e.group?s+=" message-followup":s+=" message-first",s},onClickOutside(e){this.openedDropdown=!1}}},Q={key:0,class:"flex items-center gap-1"},R={class:"message-author"},W={key:0,class:"user"},X={key:1,class:"character"},Y={key:2,class:"unknown"},Z={class:"grow"},$={key:0,class:"text-xs text-neutral-content"},ee={key:0,class:"message-options"},se={class:""},te=r("i",{class:"fa-solid fa-caret-down","aria-hidden":"true"},null,-1),ae=[te],ne={key:1,class:"flex gap-1"},ie={class:"comment-text"},le=["title"];function re(e,s,t,o,g,a){const d=U("click-outside");return n(),l("div",{class:k(a.boxClasses(t.message))},[t.message.group?h("",!0):(n(),l("div",Q,[r("div",R,[a.isUser?(n(),l("strong",W,u(t.message.user),1)):a.isCharacter?(n(),l("strong",X,[r("span",null,u(t.message.character),1)])):(n(),l("strong",Y,u(a.translate("user_unknown")),1))]),r("div",Z,[t.message.group?h("",!0):(n(),l("span",$,u(t.message.created_at),1))]),t.message.can_delete?(n(),l("div",ee,[x((n(),l("div",se,[this.openedDropdown?(n(),l("div",ne,[r("a",{class:"btn2 btn-xs btn-default",onClick:s[1]||(s[1]=c=>a.editMessage(t.message))},u(a.translate("edit")),1),r("a",{class:"btn2 btn-xs btn-error",onClick:s[2]||(s[2]=c=>a.deleteMessage(t.message))},u(a.translate("remove")),1)])):(n(),l("a",{key:0,onClick:s[0]||(s[0]=c=>a.openDropdown()),role:"button"},ae))])),[[d,a.onClickOutside]])])):h("",!0)])),r("div",ie,[V(u(t.message.message)+" ",1),t.message.is_updated?(n(),l("span",{key:0,class:"text-xs text-neutral-content italic float-right",title:t.message.updated_at},u(a.translate("is_updated")),9,le)):h("",!0)])],2)}const oe=M(G,[["render",re]]),de={props:{target:void 0,api:void 0,targets:void 0,disabled:{type:Boolean},current_message:{type:Object,default:null},trans:void 0},emits:["sending_message","edited_message","sent_message"],data(){return{body:null,sending:!1,character_id:null,message_id:null,edit_message:null}},methods:{typing(e){e.keyCode===13&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())},editMessage(e){this.message_id=e.id,this.edit_message=e,this.body=e.message,this.character_id=e.from_id,document.getElementById("message").focus()},sendMessage(){if(!this.body||this.body.trim()===""||this.targetCharacter&&this.character_id===null)return;this.sending=!0,this.$emit("sending_message");let e=this.api,s={message:this.body.trim()};this.targetCharacter&&(s.character_id=this.character_id),this.message_id?(e+="/"+this.message_id,axios.put(e,s).then(t=>{this.$emit("edited_message",t.data.data),this.messageHandler()}).catch(()=>{this.sending=!1})):axios.post(e,s).then(()=>{this.messageHandler()}).catch(()=>{this.sending=!1})},messageHandler(){this.sending=!1,this.body=null,this.message_id=null,this.$emit("sent_message")},translate(e){return this.json_trans[e]??"unknown"},boxClass(){let e="bg-base-100";return this.current_message&&(e="bg-accent"),"box-footer rounded p-2 "+e}},computed:{targetCharacter:function(){return this.target==="character"},inputFormDisabled:function(){return this.sending},commentable:function(){return this.targetCharacter?this.targets!==null:!0}},watch:{current_message:{handler(e,s){e!==s&&e&&this.editMessage(e)}}}},ce={class:"flex items-center gap-2"},ue={key:0,class:"max-w-xs"},ge=["value"],me={class:"field grow"},he=["placeholder","disabled"];function _e(e,s,t,o,g,a){return a.commentable?(n(),l("div",{key:0,class:k(a.boxClass())},[r("div",ce,[a.targetCharacter?(n(),l("div",ue,[x(r("select",{class:"w-full","onUpdate:modelValue":s[0]||(s[0]=d=>g.character_id=d)},[(n(!0),l(w,null,C(t.targets,(d,c)=>(n(),l("option",{value:c,key:c},u(d),9,ge))),128))],512),[[z,g.character_id]])])):h("",!0),r("div",me,[x(r("input",{type:"text",id:"message",maxlength:"1000",autocomplete:"off",class:"w-full",onKeydown:s[1]||(s[1]=(...d)=>a.typing&&a.typing(...d)),"onUpdate:modelValue":s[2]||(s[2]=d=>g.body=d),placeholder:t.disabled?a.translate("is_closed"):"",disabled:a.inputFormDisabled||t.disabled},null,40,he),[[I,g.body]])])])],2)):h("",!0)}const fe=M(de,[["render",_e]]),ve={class:"viewport box-conversation p-2 flex flex-col gap-2"},pe={key:1,class:"load-more text-center text-2xl"},xe=r("i",{class:"fa-solid fa-spin fa-spinner","aria-label":"Loading"},null,-1),be=[xe],ye={key:2,class:"text-center"},ke=r("i",{class:"fa-solid fa-spin fa-spinner"},null,-1),we=[ke],Ce=K({__name:"Conversation",props:{id:null,send:null,target:null,api:null,targets:null,trans:null,disabled:{type:Boolean}},setup(e){const s=e,t=m(),o=m([]),g=m(!1),a=m(null),d=m(!1),c=m(!1),b=m(!0),v=m(null),p=m(null),y=()=>{axios.get(s.api,{params:{newest:a.value}}).then(i=>{g.value=!1,o.value.push(...i.data.data.messages),d.value=i.data.data.previous,b.value=!1,B()})},B=()=>{setTimeout(()=>{v.value.scrollTop=v.value.scrollHeight},50),o.value.length>0?a.value=o.value[o.value.length-1].id:a.value=void 0},O=()=>{c.value=!0,axios.get(s.api,{params:{oldest:o.value[0].id}}).then(i=>{o.value.unshift(...i.data.data.messages),d.value=i.data.data.previous,c.value=!1})},F=i=>{axios.delete(i.delete_url).then(()=>{const f=o.value.findIndex(_=>_.id===i.id);o.value.splice(f,1)})},N=i=>t.value[i]??"unknown",S=i=>{g.value=!0},T=i=>{p.value=i},j=i=>{const f=o.value.findIndex(_=>_.id===i.id);o.value[f]=i},E=i=>{p.value=null,y()},H=i=>{F(i)};return L(()=>{t.value=JSON.parse(s.trans),y()}),(i,f)=>(n(),l("div",ve,[r("div",{class:"flex flex-col gap-2 box-comments overflow-auto",ref_key:"messageBox",ref:v},[d.value&&!c.value?(n(),l("div",{key:0,class:"load-more cursor-pointer text-center hover:text-primary",onClick:O},u(N("load_previous")),1)):h("",!0),c.value||b.value?(n(),l("div",pe,be)):h("",!0),(n(!0),l(w,null,C(o.value,_=>(n(),q(oe,{key:_.id,message:_,trans:t.value,onDelete_message:H,onEdit_message:T},null,8,["message","trans"]))),128)),g.value?(n(),l("div",ye,we)):h("",!0)],512),P(fe,{api:e.send,target:e.target,targets:e.targets,disabled:e.disabled,trans:t.value,current_message:p.value,onSending_message:S,onEdited_message:j,onSent_message:E},null,8,["api","target","targets","disabled","trans","current_message"])]))}}),D=A({});D.component("conversation",Ce);D.mount("#conversation");
