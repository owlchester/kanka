import{m as y,b as a,c as i,a as o,t as c,e as u,j as h,f as b,g as k,F as v,r as x,h as w,i as _,u as C,v as M,l as p,p as D}from"./vue.esm-bundler-bbd25308.js";import{m as B}from"./mitt-f7ef348c.js";import{v as P}from"./v-click-outside.umd-1708c20a.js";import{_ as m}from"./_plugin-vue_export-helper-c27b6911.js";import"./_commonjsHelpers-725317a4.js";const F={directives:{clickOutside:P.directive},props:["message","trans"],data(){return{openedDropdown:!1}},computed:{isUser:function(){return this.message.user!==null},isCharacter:function(){return this.message.character!==null}},methods:{deleteMessage:function(e){this.emitter.emit("delete_message",e)},editMessage:function(e){this.emitter.emit("edit_message",e)},translate(e){return this.trans[e]??"unknown"},dropdownClass(){return this.openedDropdown?"open dropdown relative":"dropdown relative"},openDropdown(){return this.openedDropdown=!0},boxClasses:function(e){let s="box-comment bg-base-200 px-1 py-3 flex flex-col gap-1";return s+=" message-author-"+e.from_id,s+=" message-real-author-"+e.created_by,e.group?s+=" message-followup":s+=" message-first mt-2",s},onClickOutside(e){this.openedDropdown=!1}}},T={key:0,class:"flex items-center gap-1"},j={class:"message-author"},V={key:0,class:"user"},N={key:1,class:"character"},O={key:2,class:"unknown"},z={class:"grow"},H={key:0,class:"text-xs text-neutral-content"},U={key:0,class:"message-options mr-1"},I={class:""},S=o("i",{class:"fa-solid fa-caret-down","aria-hidden":"true"},null,-1),E=[S],K={key:1,class:"flex gap flex-row"},A={class:"comment-text"},J=["title"];function L(e,s,t,g,r,n){const d=y("click-outside");return a(),i("div",{class:k(n.boxClasses(t.message))},[t.message.group?u("",!0):(a(),i("div",T,[o("div",j,[n.isUser?(a(),i("strong",V,c(t.message.user),1)):n.isCharacter?(a(),i("strong",N,[o("span",null,c(t.message.character),1)])):(a(),i("strong",O,c(n.translate("user_unknown")),1))]),o("div",z,[t.message.group?u("",!0):(a(),i("span",H,c(t.message.created_at),1))]),t.message.can_delete?(a(),i("div",U,[h((a(),i("div",I,[this.openedDropdown?(a(),i("div",K,[o("a",{class:"btn2 btn-xs",onClick:s[1]||(s[1]=l=>n.editMessage(t.message))},c(n.translate("edit")),1),o("a",{class:"btn2 btn-xs text-error",onClick:s[2]||(s[2]=l=>n.deleteMessage(t.message))},c(n.translate("remove")),1)])):(a(),i("a",{key:0,onClick:s[0]||(s[0]=l=>n.openDropdown()),role:"button"},E))])),[[d,n.onClickOutside]])])):u("",!0)])),o("div",A,[b(c(t.message.message)+" ",1),t.message.is_updated?(a(),i("span",{key:0,class:"text-xs text-neutral-content italic",title:t.message.updated_at},c(n.translate("is_updated")),9,J)):u("",!0)])],2)}const q=m(F,[["render",L]]),G={props:["api","trans"],components:{Message:q},data(){return{messages:[],sending:!1,scrolledToBottom:!1,chatBox:null,newsest:null,previous:!1,loadingPrevious:!1,initializing:!0}},methods:{getMessages:function(){axios.get(this.api,{params:{newest:this.newest}}).then(e=>{this.sending=!1,this.messages.push(...e.data.data.messages),this.previous=e.data.data.previous,this.initializing=!1,this.scrollToBottom()})},scrollToBottom:function(){setTimeout(()=>{let e=this.$refs.messagebox;e.scrollTop=e.scrollHeight},50),this.messages.length>0?this.newest=this.messages[this.messages.length-1].id:this.newest=void 0},getPrevious:function(){this.loadingPrevious=!0,axios.get(this.api,{params:{oldest:this.messages[0].id}}).then(e=>{this.messages.unshift(...e.data.data.messages),this.previous=e.data.data.previous,this.loadingPrevious=!1})},deleteMessage:function(e){axios.delete(e.delete_url).then(()=>{let s=this.messages.findIndex(t=>t.id===e.id);this.messages.splice(s,1)})},translate(e){return this.trans[e]??"unknown"}},mounted(){this.getMessages(),this.emitter.on("sending_message",()=>{this.sending=!0}),this.emitter.on("sent_message",()=>{this.getMessages()}),this.emitter.on("edited_message",e=>{let s=this.messages.findIndex(t=>t.id===e.id);this.messages[s]=e}),this.emitter.on("delete_message",(e,s)=>{this.deleteMessage(e,s)})}},Q={class:"box-comments overflow-auto",ref:"messagebox"},R={key:1,class:"load-more cursor-pointer text-center my-5"},W=o("i",{class:"fa-solid fa-spin fa-spinner"},null,-1),X=[W],Y={key:2,class:"load-more cursor-pointer text-center my-5"},Z=o("i",{class:"fa-solid fa-spin fa-spinner fa-4x"},null,-1),$=[Z],ee={key:3,class:"text-center"},se=o("i",{class:"fa-solid fa-spin fa-spinner"},null,-1),te=[se];function ne(e,s,t,g,r,n){const d=_("Message");return a(),i("div",Q,[r.previous&&!r.loadingPrevious?(a(),i("div",{key:0,class:"load-more cursor-pointer text-center my-5",onClick:s[0]||(s[0]=(...l)=>n.getPrevious&&n.getPrevious(...l))},c(n.translate("load_previous")),1)):u("",!0),r.loadingPrevious?(a(),i("div",R,X)):u("",!0),r.initializing?(a(),i("div",Y,$)):u("",!0),(a(!0),i(v,null,x(r.messages,l=>(a(),w(d,{key:l.id,message:l,trans:t.trans},null,8,["message","trans"]))),128)),r.sending?(a(),i("div",ee,te)):u("",!0)],512)}const ae=m(G,[["render",ne]]),ie={props:{target:void 0,api:void 0,targets:void 0,disabled:{type:Boolean},trans:void 0},data(){return{body:null,sending:!1,character_id:null,message_id:null,edit_message:null}},methods:{typing(e){e.keyCode===13&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())},editMessage(e){this.message_id=e.id,this.edit_message=e,this.body=e.message,document.getElementById("message").focus()},sendMessage(){if(!this.body||this.body.trim()===""||this.targetCharacter&&this.character_id===null)return;this.sending=!0,this.emitter.emit("sending_message");let e=this.api,s={message:this.body.trim()};this.targetCharacter&&(s.character_id=this.character_id),this.message_id?(e+="/"+this.message_id,axios.put(e,s).then(t=>{this.emitter.emit("edited_message",t.data.data),this.messageHandler()}).catch(()=>{this.sending=!1})):axios.post(e,s).then(()=>{this.messageHandler()}).catch(()=>{this.sending=!1})},messageHandler(){this.sending=!1,this.body=null,this.message_id=null,this.emitter.emit("sent_message")},translate(e){return this.json_trans[e]??"unknown"}},computed:{targetCharacter:function(){return this.target==="character"},inputFormDisabled:function(){return this.sending},commentable:function(){return this.targetCharacter?this.targets!==null:!0}},mounted(){this.emitter.on("edit_message",(e,s)=>{this.editMessage(e,s)})}},re={key:0,class:"box-footer mt-5"},oe={class:"flex items-center gap-2"},de={key:0,class:"max-w-xs"},le=["value"],ce={class:"field grow"},ue=["placeholder","disabled"];function me(e,s,t,g,r,n){return n.commentable?(a(),i("div",re,[o("div",oe,[n.targetCharacter?(a(),i("div",de,[h(o("select",{class:"w-full","onUpdate:modelValue":s[0]||(s[0]=d=>r.character_id=d)},[(a(!0),i(v,null,x(t.targets,(d,l)=>(a(),i("option",{value:l,key:l},c(d),9,le))),128))],512),[[C,r.character_id]])])):u("",!0),o("div",ce,[h(o("input",{type:"text",id:"message",maxlength:"1000",autocomplete:"off",class:"w-full",onKeydown:s[1]||(s[1]=(...d)=>n.typing&&n.typing(...d)),"onUpdate:modelValue":s[2]||(s[2]=d=>r.body=d),placeholder:t.disabled?n.translate("is_closed"):"",disabled:n.inputFormDisabled||t.disabled},null,40,ue),[[M,r.body]])])])])):u("",!0)}const ge=m(ie,[["render",me]]),he={props:{id:void 0,send:void 0,target:void 0,api:void 0,targets:void 0,trans:void 0,disabled:{type:Boolean}},components:{Form:ge,Messages:ae},data(){return{json_trans:[]}},mounted(){this.json_trans=JSON.parse(this.trans)}},_e={class:"viewport box-conversation"};function fe(e,s,t,g,r,n){const d=_("Messages"),l=_("Form");return a(),i("div",_e,[p(d,{api:t.api,trans:r.json_trans},null,8,["api","trans"]),p(l,{api:t.send,target:t.target,targets:t.targets,disabled:t.disabled,trans:r.json_trans},null,8,["api","target","targets","disabled","trans"])])}const pe=m(he,[["render",fe]]),ve=B(),f=D({});f.config.globalProperties.emitter=ve;f.component("conversation",pe);f.mount("#conversation");
