const g=document.querySelector("#map-body"),v=document.querySelector("#sidebar-map"),d=document.querySelector("#sidebar-marker");document.querySelector("#map-marker-modal");let y,l,c,r,s,a,f,S,k;const q=window.matchMedia("only screen and (max-width: 760px)"),u=document.querySelector('input[name="shape_id"]'),N=()=>{const e=document.querySelector('a[href="#marker-pin"]');e&&(e.addEventListener("click",function(){u.value=1,document.querySelector("#map-marker-bg-colour").classList.remove("hidden"),w()}),document.querySelector('a[href="#marker-label"]').addEventListener("click",function(){u.value=2,document.querySelector("#map-marker-bg-colour").classList.add("hidden"),w()}),document.querySelector('a[href="#marker-circle"]').addEventListener("click",function(){u.value=3,document.querySelector("#map-marker-bg-colour").classList.remove("hidden"),w()}),document.querySelector('a[href="#marker-poly"]').addEventListener("click",function(){u.value=5,document.querySelector("#map-marker-bg-colour").classList.remove("hidden"),w()}),document.querySelector('a[href="#presets"]')?.addEventListener("click",function(t){let o=t.currentTarget;G(o.dataset.presets)}),document.querySelector('a[href="#form-markers"]')?.addEventListener("click",function(){window.map.invalidateSize()}))},C=()=>{g&&(window.markerDetails=function(e){if(_(),q.matches){e=e+"?mobile=1",window.openDialog("map-marker-modal",e);return}fetch(e).then(t=>t.json()).then(t=>{d.innerHTML=t.body,d.classList.remove("hidden"),d.parentNode.querySelector(".spinner").classList.add("hidden"),z(),g.classList.add("sidebar-open"),window.triggerEvent()})},U(),E(),O(),$(document).on("expanded.pushMenu collapsed.pushMenu",function(){window.map.invalidateSize()}))},F=()=>{N(),H(),Z();const e=document.querySelector("#map-marker-form"),t=document.querySelector(".map-marker-edit-form");!e&&!t||(e.onsubmit=function(){window.entityFormHasUnsavedChanges=!1},E())},H=()=>{const e=document.querySelector('select[name="size_id"]');e&&e.addEventListener("change",function(t){e.value==6?(document.querySelector(".map-marker-circle-helper").classList.add("hidden"),document.querySelector(".map-marker-circle-radius").classList.remove("hidden")):(document.querySelector(".map-marker-circle-radius").classList.add("hidden"),document.querySelector(".map-marker-circle-helper").classList.remove("hidden"))})},_=()=>{q.matches||(g.classList.remove("sidebar-collapse"),g.classList.add("sidebar-open"),v.classList.add("hidden"),d.innerHTML="",d.classList.remove("hidden"),d.parentNode.querySelector(".spinner").classList.remove("hidden"),x())},z=()=>{document.querySelector(".marker-close")?.addEventListener("click",function(){d.classList.add("hidden"),v.classList.remove("hidden")})},U=()=>{const e=document.getElementById("ticker-config");f=e.dataset.timeout,S=e.dataset.url,k=e.dataset.ts,setTimeout(b,f)},b=()=>{fetch(S+"?ts="+k).then(e=>e.json()).then(e=>{k=e.ts;for(let t in e.markers){let o=e.markers[t];window["marker"+o.id]&&window["marker"+o.id].setLatLng({lon:o.longitude,lat:o.latitude})}setTimeout(b,f)})},E=()=>{document.querySelectorAll(".map-legend-marker")?.forEach(e=>{e.addEventListener("click",function(t){t.preventDefault(),window.map.panTo(L.latLng(e.dataset.lat,e.dataset.lng)),window[e.dataset.id].openPopup()})}),document.querySelector("a.sidebar-toggle")?.addEventListener("click",function(){x()})},x=()=>{setTimeout(()=>{window.map.invalidateSize()},500)},O=()=>{LControlZoomDisplay.default(L,{position:"bottomleft",prefix:"Zoom : "}),L.control.zoomDisplay().addTo(window.map)},j=()=>{document.querySelector(".map-marker-entry-click")?.addEventListener("click",function(e){e.preventDefault(),e.target.parentNode.classList.add("hidden"),document.querySelector(".map-marker-entry-entry").classList.remove("hidden")})},B=()=>{document.querySelector(".btn-mode-enable")?.addEventListener("click",function(t){t.preventDefault(),window.exploreEditMode=!0,document.querySelector("body").classList.add("map-edit-mode")}),document.querySelector(".btn-mode-disable")?.addEventListener("click",function(t){t.preventDefault(),window.exploreEditMode=!1,document.querySelector("body").classList.remove("map-edit-mode"),window.polygon&&window.map.removeLayer(window.polygon)}),document.querySelector(".btn-mode-drawing")?.addEventListener("click",function(t){t.preventDefault(),P()})},P=()=>{window.drawingPolygon=!1,document.querySelector("body").classList.remove("map-drawing-mode"),window.openDialog("marker-modal")},Z=()=>{const e=document.querySelector("#start-drawing-polygon");e&&(e.addEventListener("click",function(t){t.preventDefault(),window.exploreEditMode=!1,window.startNewPolygon(),window.showToast(t.currentTarget.dataset.toast),document.querySelector("body").classList.add("map-drawing-mode"),window.closeDialog("marker-modal")}),y=document.querySelector("#reset-polygon"),y.addEventListener("click",function(t){t.preventDefault(),window.polygon&&window.map.removeLayer(window.polygon),document.querySelector('textarea[name="custom_shape"]').value="",y.classList.add("hidden"),window.startNewPolygon()}),window.map.on("editable:editing",function(t){M()&&(D(),t.layer.setStyle({weight:l,color:c,opacity:r,fillColor:s,fillOpacity:a}))}))};window.startNewPolygon=function(){window.polygon=window.map.editTools.startPolygon();let e=!0;window.polygon.on("editable:dragend",window.markerUpdateHandler),window.polygon.on("editable:vertex:new",window.markerUpdateHandler),window.polygon.on("editable:vertex:dragend",window.markerUpdateHandler),window.polygon.on("editable:vertex:dragend",window.markerUpdateHandler),window.polygon.on("editable:drawing:end",function(t){e=!1}),window.polygon.on("click",function(t){e||P()})};window.setPolygonPosition=function(e){let t=document.querySelector('textarea[name="custom_shape"]');t.value=e};window.markerUpdateHandler=function(e){M()?A(e):I()&&W(e)};const A=e=>{let t=e.target.getLatLngs();if(t.length===0)return;let o=[];t[0].forEach(n=>{o.push(n.lat.toFixed(3)+","+n.lng.toFixed(3))}),window.setPolygonPosition(o.join(" "))},W=e=>{let t=e.target._latlng;t&&(document.querySelector("#marker-latitude").value=t.lat.toFixed(3),document.querySelector("#marker-longitude").value=t.lng.toFixed(3))},M=()=>Number(u.value)===5,I=()=>Number(u.value)===2;window.addPolygonPosition=function(e,t){const o=document.querySelector('textarea[name="custom_shape"]');let n=o.value;n.length>0&&(n+=" "),o.value=n+e+","+t;let p=o.value.trim(" ").split(" "),i=[];p.forEach(T=>{let h=T.split(",");i.push([h[0],h[1]])},i),window.polygon&&window.map.removeLayer(window.polygon),D(),window.polygon=L.polygon(i,{weight:l,color:c,opacity:r,fillColor:s,fillOpacity:a,linecap:"round",linejoin:"round"}),window.polygon.addTo(window.map),y.classList.remove("hidden")};const D=()=>{c=document.querySelector('input[name="polygon_style[stroke]"]')?.value,(!c||c.length<7)&&(c="red"),r=document.querySelector('input[name="polygon_style[stroke-opacity]"]').value,isNaN(r)||!r?r=1:r=r/100,s=document.querySelector('input[name="colour"]').value,(!s||s.length<7)&&(s="red"),a=document.querySelector('input[name="opacity"]').value,isNaN(a)?a=.5:a=a/100,l=document.querySelector('input[name="polygon_style[stroke-width]"]').value,(isNaN(l)||!l)&&(l=1)},w=()=>{document.querySelector("#marker-main-fields")?.classList.remove("hidden"),document.querySelector("#marker-footer")?.classList.remove("hidden")},G=e=>{if(!e){console.log("aaa");return}document.querySelector("#marker-main-fields")?.classList.add("hidden"),document.querySelector("#marker-footer")?.classList.add("hidden");const t=document.querySelector(".marker-preset-list");t.dataset.loaded!=="1"&&(t.dataset.loaded="1",fetch(e).then(o=>o.text()).then(o=>{t.innerHTML=o,J()}))},J=()=>{document.querySelectorAll(".preset-use")?.forEach(e=>{e.addEventListener("click",function(t){t.preventDefault();let o=e.dataset.url;e.classList.add("loading"),axios.get(o).then(n=>{e.classList.remove("loading"),Object.keys(n.data.preset).forEach(m=>{let p=n.data.preset[m],i=document.querySelector('[name="'+m+'"]');i&&(m.endsWith("colour")?(i.value=p,document.querySelector('[name="'+m+'"]').dispatchEvent(new Event("input"))):i.value=p)}),document.querySelector('a[href="#marker-pin"]').click()})})})};function K(e){if(!window.exploreEditMode)return;let t=e.latlng,o=t.lat.toFixed(3),n=t.lng.toFixed(3);if(window.drawingPolygon){window.addPolygonPosition(o,n);return}document.querySelector("#marker-latitude").value=o,document.querySelector("#marker-longitude").value=n,window.openDialog("marker-modal")}window.handleExploreMapClick=K;window.map.invalidateSize();window.map.on("popupopen",function(e){window.initDialogs()});C();F();j();B();
