import{l as V,a as n,c as l,b as r,t as c,f as h,w as x,g as j,e as y,u as I,F as w,r as C,v as z,d as K,o as L,i as P,k as q,h as m,q as A}from"./vue.esm-bundler-C87APpr1.js";import{v as J}from"./v-click-outside.umd-Cl-Y_A58.js";import{_ as M}from"./_plugin-vue_export-helper-DlAUqK2U.js";import"./_commonjsHelpers-Cpj98o6Y.js";const G={directives:{clickOutside:J.directive},props:["message","trans"],data(){return{openedDropdown:!1}},computed:{isUser:function(){return this.message.user!==null},isCharacter:function(){return this.message.character!==null}},emits:["delete_message","edit_message"],methods:{deleteMessage:function(e){this.$emit("delete_message",e),this.onClickOutside()},editMessage:function(e){this.$emit("edit_message",e),this.onClickOutside()},translate(e){return this.trans[e]??"unknown"},dropdownClass(){return this.openedDropdown?"open dropdown relative":"dropdown relative"},openDropdown(){return this.openedDropdown=!0},boxClasses:function(e){let s="box-comment bg-base-100 p-2 flex flex-col gap-1";return s+=" message-author-"+e.from_id,s+=" message-real-author-"+e.created_by,e.group?s+=" message-followup":s+=" message-first rounded-t-lg",s},onClickOutside(e){this.openedDropdown=!1}}},Q={key:0,class:"flex items-center gap-1"},R={class:"message-author"},W={key:0,class:"user"},X={key:1,class:"character"},Y={key:2,class:"unknown"},Z={class:"grow"},$={key:0,class:"text-xs text-neutral-content"},ee={key:0,class:"message-options"},se={class:""},te={key:1,class:"flex gap-1"},ae={class:"comment-text"},ne=["title"];function ie(e,s,t,d,g,a){const o=V("click-outside");return n(),l("div",{class:y(a.boxClasses(t.message))},[t.message.group?h("",!0):(n(),l("div",Q,[r("div",R,[a.isUser?(n(),l("strong",W,c(t.message.user),1)):a.isCharacter?(n(),l("strong",X,[r("span",null,c(t.message.character),1)])):(n(),l("strong",Y,c(a.translate("user_unknown")),1))]),r("div",Z,[t.message.group?h("",!0):(n(),l("span",$,c(t.message.created_at),1))]),t.message.can_delete?(n(),l("div",ee,[x((n(),l("div",se,[this.openedDropdown?(n(),l("div",te,[r("a",{class:"btn2 btn-xs btn-default",onClick:s[1]||(s[1]=u=>a.editMessage(t.message))},c(a.translate("edit")),1),r("a",{class:"btn2 btn-xs btn-error",onClick:s[2]||(s[2]=u=>a.deleteMessage(t.message))},c(a.translate("remove")),1)])):(n(),l("a",{key:0,onClick:s[0]||(s[0]=u=>a.openDropdown()),role:"button"},[...s[3]||(s[3]=[r("i",{class:"fa-solid fa-caret-down","aria-hidden":"true"},null,-1)])]))])),[[o,a.onClickOutside]])])):h("",!0)])),r("div",ae,[j(c(t.message.message)+" ",1),t.message.is_updated?(n(),l("span",{key:0,class:"text-xs text-neutral-content italic float-right",title:t.message.updated_at},c(a.translate("is_updated")),9,ne)):h("",!0)])],2)}const le=M(G,[["render",ie]]),re={props:{target:void 0,api:void 0,targets:void 0,disabled:{type:Boolean},current_message:{type:Object,default:null},trans:void 0},emits:["sending_message","edited_message","sent_message"],data(){return{body:null,sending:!1,character_id:null,message_id:null,edit_message:null}},methods:{typing(e){e.keyCode===13&&!e.shiftKey&&(e.preventDefault(),this.sendMessage())},editMessage(e){this.message_id=e.id,this.edit_message=e,this.body=e.message,this.character_id=e.from_id,document.getElementById("message").focus()},sendMessage(){if(!this.body||this.body.trim()===""||this.targetCharacter&&this.character_id===null)return;this.sending=!0,this.$emit("sending_message");let e=this.api,s={message:this.body.trim()};this.targetCharacter&&(s.character_id=this.character_id),this.message_id?(e+="/"+this.message_id,axios.put(e,s).then(t=>{this.$emit("edited_message",t.data.data),this.messageHandler()}).catch(()=>{this.sending=!1})):axios.post(e,s).then(()=>{this.messageHandler()}).catch(()=>{this.sending=!1})},messageHandler(){this.sending=!1,this.body=null,this.message_id=null,this.$emit("sent_message")},translate(e){return this.json_trans[e]??"unknown"},boxClass(){let e="bg-base-100";return this.current_message&&(e="bg-accent"),"rounded p-2 "+e}},computed:{targetCharacter:function(){return this.target==="character"},inputFormDisabled:function(){return this.sending},commentable:function(){return this.targetCharacter?this.targets!==null:!0}},watch:{current_message:{handler(e,s){e!==s&&e&&this.editMessage(e)}}}},de={class:"flex items-center gap-2"},oe={key:0,class:"max-w-xs"},ue=["value"],ce={class:"field grow"},ge=["placeholder","disabled"];function me(e,s,t,d,g,a){return a.commentable?(n(),l("div",{key:0,class:y(a.boxClass())},[r("div",de,[a.targetCharacter?(n(),l("div",oe,[x(r("select",{class:"w-full","onUpdate:modelValue":s[0]||(s[0]=o=>g.character_id=o)},[(n(!0),l(w,null,C(t.targets,(o,u)=>(n(),l("option",{value:u,key:u},c(o),9,ue))),128))],512),[[I,g.character_id]])])):h("",!0),r("div",ce,[x(r("input",{type:"text",id:"message",maxlength:"1000",autocomplete:"off",class:"w-full",onKeydown:s[1]||(s[1]=(...o)=>a.typing&&a.typing(...o)),"onUpdate:modelValue":s[2]||(s[2]=o=>g.body=o),placeholder:t.disabled?a.translate("is_closed"):"",disabled:a.inputFormDisabled||t.disabled},null,40,ge),[[z,g.body]])])])],2)):h("",!0)}const he=M(re,[["render",me]]),ve={class:"viewport box-conversation p-2 flex flex-col gap-2"},_e={key:1,class:"load-more text-center text-2xl"},fe={key:2,class:"text-center"},pe=K({__name:"Conversation",props:{id:{},send:{},target:{},api:{},targets:{},trans:{},disabled:{type:Boolean}},setup(e){const s=e,t=m(),d=m([]),g=m(!1),a=m(null),o=m(!1),u=m(!1),b=m(!0),f=m(null),p=m(null),k=()=>{axios.get(s.api,{params:{newest:a.value}}).then(i=>{g.value=!1,d.value.push(...i.data.data.messages),o.value=i.data.data.previous,b.value=!1,B()})},B=()=>{setTimeout(()=>{f.value.scrollTop=f.value.scrollHeight},50),d.value.length>0?a.value=d.value[d.value.length-1].id:a.value=void 0},O=()=>{u.value=!0,axios.get(s.api,{params:{oldest:d.value[0].id}}).then(i=>{d.value.unshift(...i.data.data.messages),o.value=i.data.data.previous,u.value=!1})},F=i=>{axios.delete(i.delete_url).then(()=>{const v=d.value.findIndex(_=>_.id===i.id);d.value.splice(v,1)})},N=i=>t.value[i]??"unknown",S=i=>{g.value=!0},T=i=>{p.value=i},E=i=>{const v=d.value.findIndex(_=>_.id===i.id);d.value[v]=i},H=i=>{p.value=null,k()},U=i=>{F(i)};return L(()=>{t.value=JSON.parse(s.trans),k()}),(i,v)=>(n(),l("div",ve,[r("div",{class:"flex flex-col gap-2 box-comments overflow-auto",ref_key:"messageBox",ref:f},[o.value&&!u.value?(n(),l("div",{key:0,class:"load-more cursor-pointer text-center hover:text-primary",onClick:O},c(N("load_previous")),1)):h("",!0),u.value||b.value?(n(),l("div",_e,[...v[0]||(v[0]=[r("i",{class:"fa-solid fa-spin fa-spinner","aria-label":"Loading"},null,-1)])])):h("",!0),(n(!0),l(w,null,C(d.value,_=>(n(),P(le,{key:_.id,message:_,trans:t.value,onDelete_message:U,onEdit_message:T},null,8,["message","trans"]))),128)),g.value?(n(),l("div",fe,[...v[1]||(v[1]=[r("i",{class:"fa-solid fa-spin fa-spinner"},null,-1)])])):h("",!0)],512),q(he,{api:e.send,target:e.target,targets:e.targets,disabled:e.disabled,trans:t.value,current_message:p.value,onSending_message:S,onEdited_message:E,onSent_message:H},null,8,["api","target","targets","disabled","trans","current_message"])]))}}),D=A({});D.component("conversation",pe);D.mount("#conversation");
