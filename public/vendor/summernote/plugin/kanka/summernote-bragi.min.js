(()=>{"use strict";const t=function(){function t(){this.events_queue={}}return t.prototype.on=function(t,e){return Array.isArray(this.events_queue[t])||(this.events_queue[t]=[]),this.events_queue[t].push(e),this},t.prototype.trigger=function(t,e){void 0===e&&(e=[]);for(var n=this.events_queue[t]||[],o=0;o<n.length;o++)n[o].apply(this,e);return this},t.prototype.clearAll=function(){return this.events_queue={},this},t}(),e=function(){function e(e){this.options=$.extend({maxHeight:500,title:"Kanka Bragi",close_text:"Close",ok_text:"Add"},e),this.event=new t,this.template=this.getModalTemplate(),this.$modal=$(this.template).hide(),this.addStyleToDom(),this.setOptions(),this.attachEvents()}return e.prototype.setOptions=function(){this.$modal.find(".modal-body").css("max-height",this.options.maxHeight),this.$modal.find(".modal-title").html(this.options.title),this.$modal.find("#close").html(this.options.close_text)},e.prototype.addData=function(t){this.$modal.find(".header-text").html(t.header),t.error?this.showError(t.message,!0):this.showForm(t)},e.prototype.addGenerated=function(t){this.availableTokens(t.tokens),t.error?this.showError(t.message,!0):(this.$modal.find(".generated").html(t.result).show(),this.$modal.find(".modal-footer").show(),0===t.tokens&&(this.$modal.find("form").hide(),this.showError(t.message,!0)))},e.prototype.showError=function(t,e){void 0===e&&(e=!1);var n=this.$modal.find(".message");n.html('<p class="alert alert-danger">'+t+"</p>"),n.show(),e||setTimeout((function(){n.html("").hide()}),5e3)},e.prototype.showForm=function(t){this.$modal.find("input").attr("placeholder",t.texts.placeholder),this.$modal.find("input").attr("maxlength",t.limits.prompt),this.$modal.find('button[name="submit"]').html(t.texts.submit),this.$modal.find('button[name="insert"]').html(t.texts.insert),this.$modal.find(".bragi-loading").html(t.texts.loading),this.$modal.find(".token-count").html(t.tokens),this.$modal.find(".token-text").html(t.texts.tokens),this.$modal.find("input").focus(),this.availableTokens(t.tokens),this.$modal.find('form[name="bragi-form"]').show()},e.prototype.showLoading=function(){this.$modal.find(".bragi-loader").show()},e.prototype.hideLoading=function(){this.$modal.find(".bragi-loader").hide()},e.prototype.showGenerating=function(){this.$modal.find(".bragi-loader").show(),this.$modal.find("input").prop("disabled",!0),this.$modal.find('button[name="submit"]').prop("disabled",!0),this.$modal.find(".modal-footer").hide(),this.$modal.find(".generated").hide()},e.prototype.hideGenerating=function(){this.$modal.find(".bragi-loader").hide(),this.$modal.find("input").removeAttr("disabled").focus(),this.$modal.find('button[name="submit"]').removeAttr("disabled")},e.prototype.hideErrors=function(){this.$modal.find(".message").html("")},e.prototype.attachEvents=function(){var t=this,e=this.$modal;e.find("form").submit((function(n){var o=e.find("input").val(),i=$('[name="name"]'),a={};if(i){var s=i.data("bragi-name");a.name=s||i.val()}var r=$('[name="sex"]');r&&(a.gender=r.val());var l=$('[name="pronouns"]');return l&&(a.pronouns=l.val()),t.hideErrors(),t.event.trigger("generate",[t,o,a]),!1})),e.find('button[name="insert"]').click((function(n){t.event.trigger("beforeSave",[t]),e.modal("hide"),t.event.trigger("save",[t,e.find(".generated").html()]),t.event.trigger("afterSave",[this])})),e.on("hidden.bs.modal",(function(){t.event.trigger("close")}))},e.prototype.open=function(){this.$modal.modal()},e.prototype.clearContent=function(){this.$modal.find(".images-list").html("")},e.prototype.getModalTemplate=function(){var t=['<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>','<h4 class="modal-title">[bragi title]</h4>'];return'<div class="modal summernote-bragi fade" tabindex="-1" role="dialog"><div class="modal-lg modal-dialog "><div class="modal-content"><div class="modal-header">'+(3==parseInt($.fn.modal.Constructor.VERSION)?t.join(""):t.reverse().join(""))+'</div><div class="modal-body p-8 flex flex-col gap-4 md:gap-5"><div class="flex gap-5"><img src="/images/bragi/bragi.png" alt="Bragi" class="flex-none w-40 h-40" /><div class="flex-grow flex flex-col gap-2"><p class="text-neutral-content header-text"></p><p class="text-neutral-content token-text"></p></div></div><form method="GET" action="" name="bragi-form" class="flex gap-1" style="display: none"><input type="text" name="prompt" class="w-full" data-skip-unsaved="true" /><button type="submit" name="submit" class="btn2 btn-primary"></button></form><div class="message" style="display: none"></div ><div class="generated text-break flex flex-col gap-2" style="display: none"></div><div class="text-center bragi-loader" style="display: none"><i class="fa-solid fa-spinner fa-spin fa-3x" aria-hidden="true"></i><p class="bragi-loading"></p></div></div><div class="modal-footer" style="display: none"><button name="insert" class="btn2 btn-primary"></button></div></div></div></div>'},e.prototype.addStyleToDom=function(){this.$css=$("<style>.modal.summernote-bragi .modal-body{overflow: scroll;}</style>"),this.$css.appendTo("body")},e.prototype.availableTokens=function(t){this.$modal.find(".token-amount").html(t)},e}();var n=function(){return n=Object.assign||function(t){for(var e,n=1,o=arguments.length;n<o;n++)for(var i in e=arguments[n])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},n.apply(this,arguments)};const o=function(){function e(t){this.options=n({url:null,data:[],responseDataKey:"data",nextPageKey:"links.next"},t),this.init()}return e.prototype.init=function(){this.current_page=0,this.is_fetching_locked=!1,this.event=new t,this.fetch_url=this.options.url,this.fetch_type=this.options.data.length?"data":this.fetch_url?"url":null},e.prototype.setNextFetch=function(t){t.next_link&&t.data.length?this.fetch_url=t.next_link:this.lockFetching()},e.prototype.lockFetching=function(){this.is_fetching_locked=!0},e.prototype.unlockFetching=function(){this.is_fetching_locked=!1},e.prototype.parseResponse=function(t){return{response:t}},e.prototype.fetchData=function(){var t=this;if("data"==this.fetch_type)this.event.trigger("beforeFetch"),this.event.trigger("fetch",[t.options.data]),this.event.trigger("afterFetch");else if("url"==this.fetch_type){if(this.is_fetching_locked)return;var e=t.fetch_url;this.event.trigger("beforeFetch"),this.lockFetching(),$.ajax({url:e,beforeSend:function(t){t.request_link=e}}).always((function(){t.unlockFetching()})).done((function(e,n,o){t.event.trigger("fetch",[e,t.current_page,o.request_link])})).fail((function(){t.event.trigger("error",["problem loading from "+e])})).always((function(){t.event.trigger("afterFetch")}))}else t.event.trigger("error",["options 'data' or 'url' must be set"])},e.prototype.generate=function(t,e){var n=this;this.event.trigger("beforeGenerating");var o=n.fetch_url;e.prompt=t,$.ajax({url:o,method:"POST",data:e,beforeSend:function(t){t.request_link=o}}).always((function(){n.unlockFetching()})).done((function(t,e,o){n.event.trigger("generate",[t,o.request_link])})).fail((function(t){n.event.trigger("error",[t.responseJSON.message])})).always((function(){n.event.trigger("afterGenerating")}))},e}(),i=function(){function t(t){this.options=$.extend({name:"bragi",buttonLabel:'<i class="fa-solid fa-robot"></i>',tooltip:"Bragi"},t),this.plugin_default_options={}}return t.prototype.recoverEditorFocus=function(){var t=$(this.editor).data("last_focused_element");if(void 0!==t){var e=this.editable,n=document.createRange(),o=window.getSelection(),i=t.length;n.setStart(t,i),n.collapse(!0),o.removeAllRanges(),o.addRange(n),e.focus()}},t.prototype.saveLastFocusedElement=function(){var t=window.getSelection().focusNode,e=$(this.editable).get(0);$.contains(e,t)&&$(this.editor).data("last_focused_element",t)},t.prototype.attachEditorEvents=function(){var t=this;$(this.editable).on("keypress, mousemove",(function(){t.saveLastFocusedElement()})),$(this.editable).on("click","summernote-bragi-brick .delete",(function(){})),$(this.editable).on("click","summernote-bragi-brick .edit",(function(){var e=$(this).parents("summernote-bragi-brick").data("brick");t.modal.open(e)}))},t.prototype.initBragi=function(t){this.context=t,this.editor=this.context.layoutInfo.note,this.editable=this.context.layoutInfo.editable,this.plugin_options=$.extend(this.plugin_default_options,this.context.options[this.options.name]||{}),this.modal=new e(this.plugin_options.modal),this.data_manager=new o(this.plugin_options.source),this.attachModalEvents(),this.attachEditorEvents()},t.prototype.attachModalEvents=function(){var t=this;this.modal.event.on("beforeSave",(function(e){t.recoverEditorFocus()})),this.modal.event.on("save",(function(e,n){t.context.invoke("editor.pasteHTML","<p>"+n+"</p>")})),this.modal.event.on("generate",(function(e,n,o){t.data_manager.generate(n,o)})),this.modal.event.on("close",(function(e){t.data_manager.init(),t.modal.clearContent()}))},t.prototype.createButton=function(){var t=this;return $.summernote.ui.button({className:"w-100",contents:this.options.buttonLabel,tooltip:this.options.tooltip,click:function(){t.openBragi()}}).render()},t.prototype.attachDataEvents=function(){var t=this;this.data_manager.event.on("beforeFetch",(function(){t.modal.showLoading()})).on("beforeGenerating",(function(){t.modal.showGenerating()})).on("fetch",(function(e){t.modal.addData(e)})).on("generate",(function(e){t.modal.addGenerated(e)})).on("afterFetch",(function(){t.modal.hideLoading()})).on("afterGenerating",(function(){t.modal.hideGenerating()})).on("error",(function(e){t.modal.showError(e,!0)})).on("generateError",(function(e){t.modal.showError(e)}))},t.prototype.openBragi=function(){this.attachDataEvents(),this.data_manager.fetchData(),this.modal.open()},t}();var a=new(function(){function t(t){this.summernote_bragi=new i(t)}return t.prototype.getPlugin=function(){var t={},e=this,n=this.summernote_bragi.options;return t[n.name]=function(t){var o=(t.options[n.name]||{}).buttonLabel||e.summernote_bragi.options.buttonLabel;e.summernote_bragi.options.buttonLabel=o,t.memo("button."+n.name,e.createButton()),this.events={"summernote.keyup":function(t,n){e.summernote_bragi.saveLastFocusedElement()}},this.initialize=function(){e.summernote_bragi.initBragi(t)}},t},t.prototype.createButton=function(){return this.summernote_bragi.createButton()},t}())({});$.extend($.summernote.plugins,a.getPlugin())})();
//# sourceMappingURL=summernote-bragi.min.js.map