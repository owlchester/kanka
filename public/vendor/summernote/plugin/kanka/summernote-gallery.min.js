(()=>{"use strict";const t=function(){function t(){this.events_queue={}}return t.prototype.on=function(t,e){return Array.isArray(this.events_queue[t])||(this.events_queue[t]=[]),this.events_queue[t].push(e),this},t.prototype.trigger=function(t,e){void 0===e&&(e=[]);for(var o=this.events_queue[t]||[],n=0;n<o.length;n++)o[n].apply(this,e);return this},t.prototype.clearAll=function(){return this.events_queue={},this},t}(),e=function(){function e(e){this.options=$.extend({loadOnScroll:!1,maxHeight:500,title:"Campaign Gallery",close_text:"Close",ok_text:"Add",selectAll_text:"Select all",deselectAll_text:"Deselect all",noImageSelected_msg:"One image at least must be selected."},e),this.event=new t,this.template=this.getModalTemplate(),this.$modal=$(this.template).hide(),this.select_class="selected-img",this.addStyleToDom(),this.setOptions(),this.attachEvents()}return e.prototype.setOptions=function(){this.$modal.find(".modal-body").css("max-height",this.options.maxHeight),this.$modal.find(".modal-title").html(this.options.title),this.$modal.find("#close").html(this.options.close_text),this.$modal.find("#save").html(this.options.ok_text),this.$modal.find("#select-all").html(this.options.selectAll_text),this.$modal.find("#deselect-all").html(this.options.deselectAll_text)},e.prototype.addImages=function(t,e){var o=this.createImages(t,e);this.$modal.find(".images-list").find(".img-item").length?this.$modal.find(".images-list").append(o):this.$modal.find(".images-list").html(o)},e.prototype.createImages=function(t,e){for(var o=this,n=[],i=0;i<t.length;i++)if(t[i].folder){var a=$('<div class="img-thumbnail grow flex flex-col justify-center items-center gap-2 p-2 cursor-pointer " title="'+t[i].title+'" data-url="'+t[i].url+'"/>');a.html('<i class="'+t[i].icon+' fa-2x" aria-hidden="true"></i><span class="text-center">'+t[i].title+"</span>"),a.on("click",(function(t){o.loadFolder($(this).data("url"))})),(d=$('<div class="w-32 h-32 rounded bg-base-200 img-item relative overflow-hidden shadow-sm hover:shadow-xl flex flex-stretch"></div>')).prepend(a),n.push(d)}else{var s=$('<div class="relative w-32 h-32 flex items-end overflow-hidden bg-base-200 rounded shadow"></div>'),l=$('<img class="img-thumbnail sng-image rounded object-cover w-full h-full block " title="'+t[i].title+'" data-page="'+e+'"/>');l.attr("src",t[i].thumb),l.data("gallery-id",t[i].id),l.data("full",t[i].src),l.get(0).onload=function(){$(this).parent().siblings(".img-loading").hide(),$(this).on("click",(function(t){$(this).toggleClass(o.select_class)}))};var r=$('<div class="title-overlay absolute inset-x-0 bottom-0 bg-base-100 bg-opacity-60 backdrop-blur px-2 py-1 text-xs text-center truncate text-base-content rounded m-1">'+t[i].title+"</div>"),c=$('<i class="fa-solid fa-check absolute bottom-4 right-4 text-xl drop-shadow" aria-hidden="true"></i>');s.append(l).append(r).append(c);var d=$('<div class="rounded w-32 h-32 cursor-pointer img-item shadow-sm hover:shadow-md hover:bg-base-200 flex justify-center items-center relative overflow-none"><span class="img-loading"><i class="fa-solid fa-spinner fa-pulse fa-3x fa-fw"></i></span></div>');d.prepend(s),n.push(d)}return n},e.prototype.showError=function(t,e){void 0===e&&(e=!1);var o=this.$modal.find(".message");o.html('<span class="alert alert-danger">'+t+"</span>"),e||setTimeout((function(){o.html("")}),5e3)},e.prototype.showLoading=function(){this.$modal.find(".modal-footer .loading").show()},e.prototype.hideLoading=function(){this.$modal.find(".modal-footer .loading").hide()},e.prototype.attachEvents=function(){var t=this,e=this.$modal,o=e.find(".modal-body");e.find("button#save").click((function(o){var n=e.find(".img-item img."+t.select_class);n.length?(e.modal("hide"),t.event.trigger("beforeSave",[t]),n.each((function(e,o){t.event.trigger("save",[t,$(this)]),$(this).removeClass(t.select_class)})),t.event.trigger("afterSave",[this])):t.showError(t.options.noImageSelected_msg)}));var n=this.debounce((function(e){t.dataManagerSearch(e)}),300);e.find("#search-field").on("keyup",(function(){var t=$(this).val();n(t)})),e.on("hidden.bs.modal",(function(){t.event.trigger("close")})),e.find("button#select-all").click((function(o){e.find("img").addClass(t.select_class)})),e.find("button#deselect-all").click((function(o){e.find("img").removeClass(t.select_class)})),o.scroll((function(){var n=e.find(".images-list"),i=o.scrollTop()+o.height()>=n.height()-100,a=e.find("#search-field").val();!i||a&&""!==a||t.event.trigger("scrollBottom",[t])}))},e.prototype.open=function(){this.$modal.modal()},e.prototype.clearContent=function(){this.$modal.find(".images-list").html("")},e.prototype.imagesContainerHasScroll=function(){var t=this.$modal.find(".modal-body"),e=t.find(".images-list");return parseInt(e.height())>parseInt(t.height())},e.prototype.getModalTemplate=function(){var t=['<button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>','<h4 class="modal-title">[gallery title]</h4>','<input type="text" id="search-field" class="form-control mt-4" placeholder="Search..." />'];return'<div class="modal summernote-gallery fade" tabindex="-1" role="dialog"><div class="modal-lg modal-dialog "><div class="modal-content"><div class="modal-header">'+(3==parseInt($.fn.modal.Constructor.VERSION)?t.join(""):t.reverse().join(""))+'</div><div class="modal-body"><div class="flex flex-wrap gap-5 images-list"></div></div><div class="modal-footer"><span style="display: none;position: absolute;left: 10px;bottom: 10px;" class="loading" ><i class="fa-solid fa-spinner fa-pulse fa-3x fa-fw"></i></span ><span style="display: inline-block; margin-right: 50px;"><button type="button" id="deselect-all" class="btn btn-default">[Deselect-all]</button><button type="button" id="select-all" class="btn btn-default">[select-all]</button></span ><button type="button" id="close" class="btn btn-default" data-dismiss="modal">[Close]</button><button type="button" id="save" class="btn btn-primary">[Add]</button><span class="message" ></span ></div></div></div></div>'},e.prototype.addStyleToDom=function(){this.$css=$("<style>.img-item .fa-check{color: hsl(var(--ac)/1);}.img-item .sng-image{}.img-item .loading{position: absolute;margin: auto;top: -20px;bottom: 0;display: block;left: 0;right: 0;width: 60px;height: 42px;text-align: center;}.modal.summernote-gallery .message{display: block;padding: 30px 0 20px 0;}.modal.summernote-gallery .message:empty{display: block;padding: 0px!important;}.modal.summernote-gallery .modal-body{overflow: scroll;}.img-item .fa-check{display : none;}.img-item ."+this.select_class+"+.fa-check{display : block;color: hsl(var(--a)/1);}.img-item ."+this.select_class+"+.title-overlay {background-color: hsl(var(--a)/1);color: hsl(var(--ac)/1);}."+this.select_class+"{background-color: hsl(var(--a)/1);border: 1px solid hsl(var(--a)/1);}</style>"),this.$css.appendTo("body")},e.prototype.loadFolder=function(t){this.clearContent(),this.showLoading(),this.event.trigger("loadFolder",[this,t])},e.prototype.dataManagerSearch=function(t){t!=this.latestQuery&&(this.latestQuery=t,this.clearContent(),this.showLoading(),this.event.trigger("search",[this,t]))},e.prototype.debounce=function(t,e){var o;return function(){for(var n=this,i=[],a=0;a<arguments.length;a++)i[a]=arguments[a];clearTimeout(o),o=setTimeout((function(){return t.apply(n,i)}),e)}},e}();var o=function(){return o=Object.assign||function(t){for(var e,o=1,n=arguments.length;o<n;o++)for(var i in e=arguments[o])Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i]);return t},o.apply(this,arguments)};const n=function(){function e(t){this.options=o({url:null,data:[],responseDataKey:"data",nextPageKey:"links.next",filtering:!1},t),this.init()}return e.prototype.init=function(){this.current_page=0,this.is_fetching_locked=!1,this.event=new t,this.fetch_url=this.options.url,this.fetch_type=this.options.data.length?"data":this.fetch_url?"url":null},e.prototype.setNextFetch=function(t){t.next_link&&t.data.length?this.fetch_url=t.next_link:this.lockFetching()},e.prototype.lockFetching=function(){this.is_fetching_locked=!0},e.prototype.unlockFetching=function(){this.is_fetching_locked=!1},e.prototype.getObjectKeyByString=function(t,e,o){var n=e.split(".").reduce((function(t,e){return t?t[e]:{}}),t);return void 0===o&&(o=n),n&&!$.isEmptyObject(n)?n:o},e.prototype.parseResponse=function(t){return{data:this.getObjectKeyByString(t,this.options.responseDataKey,[]),next_link:this.getObjectKeyByString(t,this.options.nextPageKey,null)}},e.prototype.fetchData=function(){var t=this;if(!this.filtering)if("data"==this.fetch_type)this.event.trigger("beforeFetch"),this.event.trigger("fetch",[t.options.data]),this.event.trigger("afterFetch");else if("url"==this.fetch_type){if(this.is_fetching_locked)return;var e=t.fetch_url;this.event.trigger("beforeFetch"),this.lockFetching(),$.ajax({url:e,beforeSend:function(t){t.request_link=e}}).always((function(){t.unlockFetching()})).done((function(e,o,n){var i=t.parseResponse(e);t.current_page++,t.setNextFetch(i),t.event.trigger("fetch",[i.data,t.current_page,n.request_link,i.next_link])})).fail((function(){t.event.trigger("error",["problem loading from "+e])})).always((function(){t.event.trigger("afterFetch")}))}else t.event.trigger("error",["options 'data' or 'url' must be set"])},e.prototype.fetchNext=function(){"url"==this.fetch_type&&this.fetchData()},e.prototype.fetchFolder=function(t){var e=this,o=t;this.event.trigger("beforeFetch"),this.lockFetching(),$.ajax({url:o,beforeSend:function(t){t.request_link=o}}).always((function(){e.unlockFetching()})).done((function(t,o,n){var i=e.parseResponse(t);e.current_page++,e.setNextFetch(i),e.event.trigger("fetch",[i.data,e.current_page,n.request_link,i.next_link])})).fail((function(){e.event.trigger("error",["problem loading from "+o])})).always((function(){e.event.trigger("afterFetch")}))},e.prototype.search=function(t){var e=this;if(!t||""===t)return this.filtering=!1,this.current_page=0,this.fetch_url=this.options.url,void this.fetchData();this.filtering=!0,this.event.trigger("beforeFetch");var o=this.options.url+"?name="+t;this.lockFetching(),$.ajax({url:o,beforeSend:function(t){t.request_link=o}}).always((function(){e.unlockFetching()})).done((function(t,o,n){var i=e.parseResponse(t);e.current_page++,e.setNextFetch(i),e.event.trigger("fetch",[i.data,e.current_page,n.request_link,i.next_link])})).fail((function(){e.event.trigger("error",["problem loading from "+o])})).always((function(){e.event.trigger("afterFetch")}))},e}(),i=function(){function t(t){this.options=$.extend({name:"summernoteGallery",buttonLabel:'<i class="fa-solid fa-file-image"></i>',tooltip:"summernoteGallery"},t),this.plugin_default_options={}}return t.prototype.recoverEditorFocus=function(){var t=$(this.editor).data("last_focused_element");if(void 0!==t){var e=this.editable,o=document.createRange(),n=window.getSelection(),i=t.length;o.setStart(t,i),o.collapse(!0),n.removeAllRanges(),n.addRange(o),e.focus()}},t.prototype.saveLastFocusedElement=function(){var t=window.getSelection().focusNode,e=$(this.editable).get(0);$.contains(e,t)&&$(this.editor).data("last_focused_element",t)},t.prototype.attachEditorEvents=function(){var t=this;$(this.editable).on("keypress, mousemove",(function(){t.saveLastFocusedElement()})),$(this.editable).on("click","summernote-gallery-brick .delete",(function(){})),$(this.editable).on("click","summernote-gallery-brick .edit",(function(){var e=$(this).parents("summernote-gallery-brick").data("brick");t.modal.open(e)}))},t.prototype.initGallery=function(t){this.context=t,this.editor=this.context.layoutInfo.note,this.editable=this.context.layoutInfo.editable,this.plugin_options=$.extend(this.plugin_default_options,this.context.options[this.options.name]||{}),this.modal=new e(this.plugin_options.modal),this.data_manager=new n(this.plugin_options.source),this.attachModalEvents(),this.attachEditorEvents()},t.prototype.attachModalEvents=function(){var t=this;this.modal.event.on("beforeSave",(function(e){t.recoverEditorFocus()})),this.modal.event.on("save",(function(e,o){t.context.invoke("editor.pasteHTML",'<img src="'+o.data("full")+'" alt="'+(o.attr("alt")||"")+'" data-gallery-id="'+(o.data("gallery-id")||"")+'" />')})),this.modal.event.on("scrollBottom",(function(e){t.modal.options.loadOnScroll&&t.data_manager.fetchNext()})),this.modal.event.on("loadFolder",(function(e,o){t.data_manager.fetchFolder(o)})),this.modal.event.on("close",(function(e){t.data_manager.init(),t.modal.clearContent()})),this.modal.event.on("search",(function(e,o){t.data_manager.search(o)}))},t.prototype.createButton=function(){var t=this;return $.summernote.ui.button({className:"btn-gallery",contents:this.options.buttonLabel,tooltip:this.options.tooltip,click:function(){t.openGallery()}}).render()},t.prototype.attachDataEvents=function(){var t=this;this.data_manager.event.on("beforeFetch",(function(){t.modal.showLoading()})).on("fetch",(function(e,o,n){t.modal.addImages(e,o),setTimeout((function(){t.modal.options.loadOnScroll&&!t.modal.imagesContainerHasScroll()&&t.data_manager.fetchNext()}),2e3)})).on("afterFetch",(function(){t.modal.hideLoading()})).on("error",(function(e){t.modal.showError(e,!0)}))},t.prototype.openGallery=function(){this.attachDataEvents(),this.data_manager.fetchData(),this.modal.open()},t}();var a=new(function(){function t(t){this.summernote_gallery=new i(t)}return t.prototype.getPlugin=function(){var t={},e=this,o=this.summernote_gallery.options;return t[o.name]=function(t){var n=t.options[o.name]||{},i=n.buttonLabel||e.summernote_gallery.options.buttonLabel;e.summernote_gallery.options.buttonLabel=i;var a=n.tooltip||e.summernote_gallery.options.tooltip;e.summernote_gallery.options.tooltip=a,t.memo("button."+o.name,e.createButton()),this.events={"summernote.keyup":function(t,o){e.summernote_gallery.saveLastFocusedElement()}},this.initialize=function(){e.summernote_gallery.initGallery(t)}},t},t.prototype.createButton=function(){return this.summernote_gallery.createButton()},t}())({});$.extend($.summernote.plugins,a.getPlugin())})();
//# sourceMappingURL=summernote-gallery.min.js.map